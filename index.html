<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pablo - A Conversational AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      overflow-y: auto;
    }
    .typing-animation::after {
      content: '|';
      animation: blink-caret 0.75s step-end infinite;
    }
    @keyframes blink-caret {
      from, to { border-color: transparent }
      50% { border-color: currentColor; }
    }
    textarea {
      resize: none;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-black text-gray-100 p-4 flex flex-col items-center justify-center min-h-screen">

  <!-- Pop-up for story prompt -->
  <div id="story-popup" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-sm">
      <h2 class="text-xl font-bold mb-4 text-center">Tell me a story idea...</h2>
      <textarea id="story-prompt-input" class="w-full p-3 rounded-xl bg-gray-700 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors resize-none" rows="3" placeholder="e.g., A robot who learns to love gardening."></textarea>
      <div class="flex justify-end mt-4 space-x-2">
        <button id="cancel-story-btn" class="px-4 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-500 transition-colors">Cancel</button>
        <button id="generate-story-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-xl hover:bg-indigo-400 transition-colors disabled:bg-gray-600 disabled:text-gray-400">Generate Story</button>
      </div>
    </div>
  </div>

  <!-- Container for the centered content -->
  <div class="flex flex-col items-center justify-center h-full w-full">
    <!-- Chat header -->
    <header class="bg-gray-800 p-4 rounded-xl shadow-lg mb-4 text-center w-full max-w-lg">
      <h1 class="text-3xl font-bold text-indigo-300">Pablo ðŸ¤–</h1>
    </header>

    <!-- Main chat window -->
    <div id="chat-window" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-800 rounded-xl shadow-inner w-full max-w-lg mb-4">
      <div id="messages-end"></div>
    </div>

    <!-- Input form and feature buttons -->
    <div class="relative flex flex-col items-center w-full max-w-lg space-y-2">
      <button id="story-btn" class="w-full px-4 py-3 bg-fuchsia-500 text-white rounded-xl hover:bg-fuchsia-400 transition-colors font-semibold shadow-lg disabled:bg-gray-600 disabled:text-gray-400">
        âœ¨ Write a Story
      </button>
      <div class="relative flex items-center w-full">
        <textarea id="message-input" class="w-full p-4 pr-16 rounded-xl bg-gray-700 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors resize-none" rows="1" placeholder="Type your message..."></textarea>
        <button id="send-btn" class="absolute right-4 bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-400 transition-colors duration-300 disabled:bg-gray-600 disabled:text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send">
            <path d="m22 2-7 19-3-6-6-3 19-7z" />
            <path d="M11 13 9 9" />
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // DOM elements
      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const chatWindow = document.getElementById('chat-window');
      const messagesEnd = document.getElementById('messages-end');
      const storyBtn = document.getElementById('story-btn');
      const storyPopup = document.getElementById('story-popup');
      const cancelStoryBtn = document.getElementById('cancel-story-btn');
      const generateStoryBtn = document.getElementById('generate-story-btn');
      const storyPromptInput = document.getElementById('story-prompt-input');

      let isLoading = false;
      let conversationHistory = [];

      // Function to show/hide loading spinner and disable buttons
      const setLoading = (loading) => {
        isLoading = loading;
        messageInput.disabled = loading;
        sendBtn.disabled = loading || !messageInput.value.trim();
        storyBtn.disabled = loading;
        if (storyPromptInput) {
          generateStoryBtn.disabled = loading || !storyPromptInput.value.trim();
        }
      };

      // Function to scroll chat window to the bottom
      const scrollToBottom = () => {
        messagesEnd.scrollIntoView({ behavior: 'smooth' });
      };

      // Function to append a message to the chat window
      const appendMessage = (sender, text, isTyping = false) => {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('flex', 'p-2');
        if (sender === 'user') {
          messageContainer.classList.add('justify-end');
        } else {
          messageContainer.classList.add('justify-start');
        }

        const messageBubble = document.createElement('div');
        messageBubble.classList.add('max-w-xs', 'md:max-w-md', 'p-3', 'rounded-xl', 'shadow-md');
        if (sender === 'user') {
          messageBubble.classList.add('bg-indigo-500', 'text-white', 'rounded-br-none');
        } else {
          messageBubble.classList.add('bg-gray-700', 'text-gray-100', 'rounded-bl-none');
        }

        const messageText = document.createElement('p');
        messageText.classList.add('prose', 'prose-invert', 'text-gray-200');
        messageBubble.appendChild(messageText);

        messageContainer.appendChild(messageBubble);
        chatWindow.appendChild(messageContainer);

        if (isTyping) {
          let i = 0;
          const typingInterval = setInterval(() => {
            if (i < text.length) {
              messageText.textContent += text.charAt(i);
              i++;
            } else {
              clearInterval(typingInterval);
              // Remove the blinking cursor once typing is complete
              messageText.classList.remove('typing-animation');
            }
          }, 25); // Typing speed in milliseconds
          messageText.classList.add('typing-animation');
        } else {
          messageText.textContent = text;
        }

        scrollToBottom();
      };

      // Function to simulate a typing indicator
      const showTypingIndicator = () => {
        const indicatorContainer = document.createElement('div');
        indicatorContainer.id = 'typing-indicator';
        indicatorContainer.classList.add('flex', 'justify-start', 'p-2');
        indicatorContainer.innerHTML = `
          <div class="bg-gray-700 p-3 rounded-xl rounded-bl-none shadow-md">
            <div class="flex items-center space-x-2">
              <div class="h-2 w-2 rounded-full bg-indigo-400 animate-bounce" style="animation-delay: 0s;"></div>
              <div class="h-2 w-2 rounded-full bg-indigo-400 animate-bounce" style="animation-delay: 0.1s;"></div>
              <div class="h-2 w-2 rounded-full bg-indigo-400 animate-bounce" style="animation-delay: 0.2s;"></div>
            </div>
          </div>
        `;
        chatWindow.appendChild(indicatorContainer);
        scrollToBottom();
      };

      // Function to remove the typing indicator
      const hideTypingIndicator = () => {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
          indicator.remove();
        }
      };

      // Main function to send a message to the AI
      const sendMessage = async (message) => {
        if (!message.trim() || isLoading) return;
        setLoading(true);

        appendMessage('user', message);
        messageInput.value = '';
        conversationHistory.push({ role: 'user', parts: [{ text: message }] });
        showTypingIndicator();

        try {
          const payload = {
            contents: conversationHistory,
          };
          const apiKey = "AIzaSyAWYlIZj07qAG9jTLEy2X0nlnQVLwSLxMw";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();
          const aiResponseText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";

          hideTypingIndicator();
          appendMessage('pablo', aiResponseText, true);
          conversationHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
        } catch (error) {
          console.error("Failed to send message:", error);
          hideTypingIndicator();
          appendMessage('pablo', "I'm having trouble connecting right now. Please try again later.");
        } finally {
          setLoading(false);
        }
      };
      
      const deleteConversation = () => {
        setLoading(true);
        conversationHistory = [];
        chatWindow.innerHTML = '';
        chatWindow.appendChild(messagesEnd);
        setLoading(false);
      };

      // Event listeners
      sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
      messageInput.addEventListener('keydown', (e) => {
        // Only trigger send if Enter is pressed and Shift is not
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(messageInput.value);
        }
      });
      messageInput.addEventListener('input', () => {
        sendBtn.disabled = isLoading || !messageInput.value.trim();
      });

      // Story feature logic
      storyBtn.addEventListener('click', () => {
        storyPopup.classList.remove('hidden');
        storyPopup.classList.add('flex');
      });

      cancelStoryBtn.addEventListener('click', () => {
        storyPopup.classList.add('hidden');
        storyPopup.classList.remove('flex');
        storyPromptInput.value = '';
      });
      

      generateStoryBtn.addEventListener('click', async () => {
        const prompt = storyPromptInput.value;
        if (!prompt.trim()) return;
        setLoading(true);

        storyPopup.classList.add('hidden');
        storyPopup.classList.remove('flex');
        storyPromptInput.value = '';
        showTypingIndicator();

        try {
          const payload = {
            contents: [{ role: 'user', parts: [{ text: `Write a short, creative story (around 150 words) based on the following idea: "${prompt}"` }] }],
          };
          const apiKey = "";
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();
          const storyText = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a story.";

          hideTypingIndicator();
          appendMessage('pablo', `Here is a story for you:\n\n${storyText}`, true);
          conversationHistory.push({ role: 'user', parts: [{ text: `Write a short story about: ${prompt}` }] });
          conversationHistory.push({ role: 'model', parts: [{ text: `Here is a story for you:\n\n${storyText}` }] });
        } catch (error) {
          console.error("Failed to generate story:", error);
          hideTypingIndicator();
          appendMessage('pablo', "I'm having trouble creating a story right now. Please try again later.");
        } finally {
          setLoading(false);
        }
      });

      storyPromptInput.addEventListener('input', () => {
        generateStoryBtn.disabled = isLoading || !storyPromptInput.value.trim();
      });

    });
  </script>
</body>
</html>
